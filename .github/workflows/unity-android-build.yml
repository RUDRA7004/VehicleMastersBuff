name: Build Vehicle Masters APK (Player Buff Only, Separate Install)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: Extract project
        run: unzip VehicleMasters_FullProject_Android15_Lite.zip -d UnityProject

      - name: Set title, package, and buff player vehicle
        run: |
          # Set Unity project PlayerSettings for title & package
          SETTINGS_FILE=$(find UnityProject -type f -name "ProjectSettings.asset")
          if [ -n "$SETTINGS_FILE" ]; then
            sed -i 's/productName: .*/productName: Vehicle Masters/' "$SETTINGS_FILE"
            sed -i 's/packageName: .*/packageName: com.vehiclemasters.buff/' "$SETTINGS_FILE"
          fi
          
          # Buff player vehicle stats (portable Bash method)
find UnityProject -type f -name "*Player*.cs" | while read FILE; do
  # maxSpeed +30%
  sed -i -E "s/(maxSpeed\s*=\s*)([0-9]+)/echo \$((\2 + \2*30/100))/e" "$FILE"
  # acceleration +25%
  sed -i -E "s/(acceleration\s*=\s*)([0-9]+)/echo \$((\2 + \2*25/100))/e" "$FILE"
  # steerSensitivity +20%
  sed -i -E "s/(steerSensitivity\s*=\s*)([0-9]+)/echo \$((\2 + \2*20/100))/e" "$FILE"
done

      - name: Cache Unity
        uses: actions/cache@v3
        with:
          path: ~/.cache/unity
          key: ${{ runner.os }}-unity

      - name: Build Android APK
        uses: game-ci/unity-builder@v2
        with:
          unityVersion: 2022.3.0f1
          targetPlatform: Android
          projectPath: UnityProject
          buildName: VehicleMasters_Android15_PlayerBuff
          buildPath: build

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: VehicleMasters_Android15_PlayerBuff
          path: build/*.apk
          
